@page "/nguoi-dung"
@model PosLite.Pages.Users.IndexModel
@{
	ViewData["Title"] = "Người dùng";
}

<div class="d-flex align-items-center justify-content-between mb-3">
	<div>
		<h1 class="h4 mb-1">Người dùng</h1>
		<div class="text-secondary small">Tạo tài khoản & đặt lại mật khẩu</div>
	</div>

	<div class="d-flex gap-2">
		<button class="btn btn-primary"
				data-bs-toggle="modal" data-bs-target="#usrModal"
				hx-get="/Users/CreateModal"
				hx-target="#usrModalContent" hx-swap="innerHTML">
			<i class="bi bi-person-plus me-1"></i> Tạo người dùng
		</button>

		<button class="btn btn-warning" id="btnBulkDeactivate" disabled>
			<i class="bi bi-lock me-1"></i> Khóa
		</button>

		<button class="btn btn-success" id="btnBulkActivate" disabled>
			<i class="fas fa-unlock me-1"></i> Mở khóa
		</button>
	</div>
</div>

<form method="get" class="row g-2 mb-3">
	<input type="hidden" name="pageIndex" value="1" />
	<div class="col-lg-4">
		<div class="input-group">
			<span class="input-group-text"><i class="bi bi-search"></i></span>
			<input name="q" value="@Model.q" class="form-control" placeholder="Email/Tên/Điện thoại..." />
		</div>
	</div>
	<div class="col-lg-2">
		<select name="status"
				class="form-select select-enhanced"
				placeholder="Chọn trạng thái"
				data-search="true"
				data-allow-clear="true"
				data-autosubmit="false">
			<option value="all" selected="@(Model.status == "all" ? "selected" : null)">Tất cả</option>
			<option value="active" selected="@(Model.status == "active" ? "selected" : null)">Đang sử dụng</option>
			<option value="inactive" selected="@(Model.status == "inactive" ? "selected" : null)">Đã khóa</option>
		</select>
	</div>

	<div class="col-lg-2">
		<select name="pageSize"
				class="form-select select-enhanced"
				placeholder="Chọn số dòng trên trang"
				data-search="true"
				data-allow-clear="true"
				data-autosubmit="false">
			@foreach (var s in new[] { 10, 20, 30, 50 })
			{
				<option value="@s" selected="@(Model.pageSize==s ? "selected" : null)">@s / trang</option>
			}
		</select>
	</div>
	<div class="col-auto">
		<button class="btn btn-outline-secondary">Lọc</button>
	</div>
</form>


<div class="modal fade" id="usrModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content" id="usrModalContent"></div>
	</div>
</div>

<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content" id="userModalContent"></div>
	</div>
</div>

<div class="modal fade" id="resetPwdModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content" id="resetPwdModalContent"></div>
	</div>
</div>

<div class="modal fade" id="bulkDeactivateModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">
					<i class="bi bi-exclamation-triangle text-warning me-2"></i> Khóa khách hàng
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div class="mb-2">Bạn có chắc muốn khóa các khách hàng sau?</div>
				<ul id="lockNames" class="mb-0"></ul>
			</div>
			<div class="modal-footer">
				<form method="post" asp-page-handler="BulkDeactivate" id="bulkDeactivateForm"
					  asp-antiforgery="true">
					<div id="lockHiddenInputs"></div>
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Không</button>
					<button type="submit" class="btn btn-warning">Có</button>
				</form>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="bulkActivateModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">
					<i class="bi bi-check-circle text-success me-2"></i> Mở khóa người dùng
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div class="mb-2">Bạn có chắc muốn mở khóa các người dùng sau?</div>
				<ul id="unlockNames" class="mb-0"></ul>
			</div>
			<div class="modal-footer">
				<form method="post" asp-page-handler="BulkActivate" asp-antiforgery="true">
					<div id="unlockHiddenInputs"></div>
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Không</button>
					<button type="submit" class="btn btn-success">Có</button>
				</form>
			</div>
		</div>
	</div>
</div>

<div class="card">
	<div class="table-responsive">
		<table class="table table-hover align-middle mb-0">
			<thead class="table-light">
				<tr>
					<th><input type="checkbox" id="selectAll" /></th>
					<th>Email</th>
					<th>Tên đăng nhập</th>
					<th>Điện thoại</th>
					<th>Khoá</th>
					<th class="text-end">Thao tác</th>
				</tr>
			</thead>
			<tbody>
				@if (Model.Items.Count == 0)
				{
					<tr><td colspan="6" class="text-center text-secondary py-4">Không có dữ liệu.</td></tr>
				}
				else
				{
					foreach (var r in Model.Items)
					{
						<tr>
							<td>
								<input type="checkbox" name="selectedIds" value="@r.Id" class="select-item" />
							</td>
							<td class="fw-medium">@r.Email</td>
							<td>@r.UserName</td>
							<td>@r.Phone</td>
							<td>
								@if (r.LockoutEnd.HasValue && r.LockoutEnd > DateTimeOffset.UtcNow)
								{
									<span class="badge bg-danger-subtle text-danger d-inline-flex align-items-center gap-1 px-2 py-1 rounded-pill fw-semibold">
										<i class="fas fa-lock"></i> Đang khoá
									</span>
								}
								else
								{
									<span class="badge bg-success-subtle text-success d-inline-flex align-items-center gap-1 px-2 py-1 rounded-pill fw-semibold">
										<i class="fas fa-unlock"></i> Hoạt động
									</span>
								}
							</td>
							<td class="text-end">
								@if (!r.IsBase)
								{
									<button class="btn btn-sm btn-outline-primary"
											data-bs-toggle="modal" data-bs-target="#userModal"
											hx-get="/Users/EditModal?id=@r.Id"
											hx-target="#userModalContent" hx-swap="innerHTML">
										<i class="bi bi-pencil-square"></i> Sửa
									</button>
									<button class="btn btn-sm btn-outline-warning"
											data-bs-toggle="modal" data-bs-target="#resetPwdModal"
											hx-get="/Users/ResetPasswordModal?id=@r.Id"
											hx-target="#resetPwdModalContent" hx-swap="innerHTML">
										<i class="bi bi-arrow-counterclockwise"></i> Đặt lại mật khẩu
									</button>
								}
								else
								{
									<span class="text-secondary small">—</span>
								}
							</td>
						</tr>
					}
				}
			</tbody>
		</table>
	</div>

	@if (Model.TotalPages > 1)
	{
		<div class="card-footer">
			<nav>
				<ul class="pagination mb-0">
					<li class="page-item @(Model.pageIndex<=1?"disabled":"")">
						<a class="page-link" asp-page="./Index"
						   asp-route-q="@Model.q"
						   asp-route-pageIndex="@(Model.pageIndex-1)"
						   asp-route-pageSize="@Model.pageSize">Previous</a>
					</li>
					@for (int i = 1; i <= Model.TotalPages; i++)
					{
						<li class="page-item @(i==Model.pageIndex?"active":"")">
							<a class="page-link" asp-page="./Index"
							   asp-route-q="@Model.q"
							   asp-route-pageIndex="@i"
							   asp-route-pageSize="@Model.pageSize">@i</a>
						</li>
					}
					<li class="page-item @(Model.pageIndex>=Model.TotalPages?"disabled":"")">
						<a class="page-link" asp-page="./Index"
						   asp-route-q="@Model.q"
						   asp-route-pageIndex="@(Model.pageIndex+1)"
						   asp-route-pageSize="@Model.pageSize">Next</a>
					</li>
				</ul>
			</nav>
		</div>
	}
</div>

@section Scripts {
	<script>
		document.getElementById('selectAll').addEventListener('change', function () {
			const isChecked = this.checked;
			document.querySelectorAll('.select-item').forEach(cb => cb.checked = isChecked);
			document.getElementById('btnBulkDeactivate').disabled = document.querySelectorAll('.select-item:checked').length === 0;
			document.getElementById('btnBulkActivate').disabled = document.querySelectorAll('.select-item:checked').length === 0;
		});

		document.querySelectorAll('.select-item').forEach(cb => {
			cb.addEventListener('change', function () {
				const checked = document.querySelectorAll('.select-item:checked').length;
				document.getElementById('btnBulkDeactivate').disabled = checked === 0;
				document.getElementById('btnBulkActivate').disabled = checked === 0;
			});
		});

		document.getElementById('btnBulkDeactivate').addEventListener('click', function () {
			const selected = Array.from(document.querySelectorAll('.select-item:checked'));
			const lockNames = document.getElementById('lockNames');
			const lockInputs = document.getElementById('lockHiddenInputs');

			lockNames.innerHTML = '';
			lockInputs.innerHTML = '';

			selected.forEach(cb => {
				const row = cb.closest('tr');
				const email = row.querySelector('td.fw-medium')?.innerText || 'Không rõ';
				lockNames.innerHTML += `<li>${email}</li>`;
				lockInputs.innerHTML += `<input type="hidden" name="ids" value="${cb.value}" />`;
			});

			const modal = new bootstrap.Modal(document.getElementById('bulkDeactivateModal'));
			modal.show();
		});
		document.getElementById('btnBulkActivate').addEventListener('click', function () {
			const selected = Array.from(document.querySelectorAll('.select-item:checked'));
			const unlockNames = document.getElementById('unlockNames');
			const unlockInputs = document.getElementById('unlockHiddenInputs');

			unlockNames.innerHTML = '';
			unlockInputs.innerHTML = '';

			selected.forEach(cb => {
				const row = cb.closest('tr');
				const email = row.querySelector('td.fw-medium')?.innerText || 'Không rõ';
				unlockNames.innerHTML += `<li>${email}</li>`;
				unlockInputs.innerHTML += `<input type="hidden" name="ids" value="${cb.value}" />`;
			});

			const modal = new bootstrap.Modal(document.getElementById('bulkActivateModal'));
			modal.show();
		});



	</script>
}

