@page
@model PosLite.Pages.Account.ChangePasswordModalModel
@{
    Layout = null;
}

<div class="modal-header">
    <h5 class="modal-title"><i class="bi bi-key me-2"></i>Đổi mật khẩu</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
</div>

<div class="modal-body">
    <form hx-post="/Account/ChangePasswordModal" hx-swap="none" asp-antiforgery="true">
        <div asp-validation-summary="ModelOnly" class="text-danger small mb-2"></div>

        <div class="mb-3">
            <label asp-for="Input.CurrentPassword" class="form-label">Mật khẩu hiện tại</label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-lock"></i></span>
                <input asp-for="Input.CurrentPassword" type="password" class="form-control" autocomplete="current-password" />
                <button type="button" class="btn btn-outline-secondary" id="toggleCur" aria-label="Hiển thị"><i class="bi bi-eye"></i></button>
            </div>
            <span asp-validation-for="Input.CurrentPassword" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Input.NewPassword" class="form-label">Mật khẩu mới</label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                <input asp-for="Input.NewPassword" type="password" class="form-control" autocomplete="new-password" />
                <button type="button" class="btn btn-outline-secondary" id="toggleNew" aria-label="Hiển thị"><i class="bi bi-eye"></i></button>
            </div>
            <span asp-validation-for="Input.NewPassword" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Input.ConfirmPassword" class="form-label">Nhập lại mật khẩu mới</label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                <input asp-for="Input.ConfirmPassword" type="password" class="form-control" autocomplete="new-password" />
                <button type="button" class="btn btn-outline-secondary" id="toggleConf" aria-label="Hiển thị"><i class="bi bi-eye"></i></button>
            </div>
            <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="submit" class="btn btn-primary">Lưu</button>
        </div>
    </form>
</div>

<partial name="_ValidationScriptsPartial" />
<script>
  (function (scope) {
    function bind(btnId, inputId) {
      const btn  = scope.querySelector('#' + btnId);
      const inp  = scope.querySelector('#' + inputId);
      const icon = btn?.querySelector('i');
      if (!btn || !inp) return;
      btn.addEventListener('click', () => {
        const show = inp.type === 'password';
        inp.type = show ? 'text' : 'password';
        icon?.classList.toggle('bi-eye', !show);
        icon?.classList.toggle('bi-eye-slash', show);
      });
    }
    bind('toggleCur',  'Input_CurrentPassword');
    bind('toggleNew',  'Input_NewPassword');
    bind('toggleConf', 'Input_ConfirmPassword');
  })(document.currentScript.closest('.modal-content') ?? document);

    document.body.addEventListener('pwd-changed', function(){
      window.appToast?.ok('Đổi mật khẩu thành công.');
      const el = document.getElementById('pwdModal');
      if (el) bootstrap.Modal.getInstance(el)?.hide();
      const box = document.getElementById('pwdModalContent');
      if (box) box.innerHTML = '';
    });
</script>

@if (!ViewData.ModelState.IsValid)
{
    <script>window.appToast?.err('Vui lòng kiểm tra lại thông tin.');</script>
}
